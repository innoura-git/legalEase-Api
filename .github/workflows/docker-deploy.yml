name: Build and Deploy Docker Container

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'main'
        type: string
      container_name:
        description: 'Container name (optional, defaults to legalease-api)'
        required: false
        default: 'legalease-api'
        type: string

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.vars.outputs.short_sha }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Set up variables
        id: vars
        run: |
          # Get last 12 characters of commit SHA
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-12)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image will be tagged as: ${SHORT_SHA}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            BRANCH=${{ github.event.inputs.branch }}

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          port: 22
          envs: DOCKER_REGISTRY,DOCKER_IMAGE_NAME,DOCKER_USERNAME,DOCKER_PASSWORD,IMAGE_TAG
          script: |
            set -e
            
            CONTAINER_NAME="${{ github.event.inputs.container_name }}"
            IMAGE="${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
            
            echo "=== Deployment Started ==="
            echo "Container: ${CONTAINER_NAME}"
            echo "Image: ${IMAGE}"
            echo "Tag: ${IMAGE_TAG}"
            
            # Login to Docker Registry
            echo "${DOCKER_PASSWORD}" | docker login ${DOCKER_REGISTRY} -u ${DOCKER_USERNAME} --password-stdin
            
            # Pull the new image first
            echo "=== Pulling new image ==="
            docker pull ${IMAGE}
            
            # Stop and remove existing container if running
            echo "=== Stopping existing container ==="
            if docker ps -q -f name=${CONTAINER_NAME} | grep -q .; then
              echo "Container is running, stopping..."
              docker stop ${CONTAINER_NAME}
            fi
            
            if docker ps -aq -f name=${CONTAINER_NAME} | grep -q .; then
              echo "Removing old container..."
              docker rm ${CONTAINER_NAME}
            fi
            
            # Run the new container
            echo "=== Starting new container ==="
            docker run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p 8080:8080 \
              ${IMAGE}
            
            # Verify container is running
            echo "=== Verifying deployment ==="
            sleep 10
            if docker ps -q -f name=${CONTAINER_NAME} | grep -q .; then
              echo "✅ Container ${CONTAINER_NAME} is running successfully!"
              docker ps -f name=${CONTAINER_NAME}
            else
              echo "❌ Container failed to start!"
              docker logs ${CONTAINER_NAME}
              exit 1
            fi
            
            # Cleanup old images (keep last 3)
            echo "=== Cleaning up old images ==="
            docker image prune -f
            
            echo "=== Deployment Complete ==="

